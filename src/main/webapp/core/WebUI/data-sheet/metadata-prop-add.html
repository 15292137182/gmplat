<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Event_Add</title>
    <style>
        #addProEvent .el-row {
            margin-top: 20px;
        }
        .el-select-dropdown {
            z-index: 900000000 !important;
        }
    </style>
</head>
<body>
<div id="addProEvent" style="margin-top:20px">
    <el-form :label-position="labelPosition" label-width="120px" :rules="rules" :model="addProForm" ref='addProForm'
             style="padding:0 20px" class="demo-ruleForm">
        <el-form-item label="属性代码" prop="codeProInput">
            <el-input placeholder="请输入属性代码" v-model="addProForm.codeProInput" ref="addProForm.codeProInput" v-bind:disabled="addProForm.disabled"></el-input>
        </el-form-item>
        <el-form-item label="属性名称" prop="nameProInput">
            <el-input placeholder="请输入属性名称" v-model="addProForm.nameProInput" ref="addProForm.nameProInput"></el-input>
        </el-form-item>
        <el-form-item label="是否为扩展属性" prop="checked">
                <el-checkbox label="" v-model="addProForm.checked"  @change.native="changEvent" v-bind:disabled="addProForm.checkEvent" name="type"></el-checkbox>
        </el-form-item>
        <el-form-item label="关联表字段" prop="tableReaInput">
            <select-contablefield ref="contablefield"></select-contablefield>
        </el-form-item>
        <el-form-item label="值类型" prop="typeInput">
            <select-vtype ref="vtype"></select-vtype>
        </el-form-item>
        <el-form-item label="值来源类型" prop="typeComValue">
            <select-vorigin ref="vorigin"></select-vorigin>
        </el-form-item>
        <el-form-item label="值来源内容" prop="comContent">
            <el-input type="textarea" placeholder="请输入值来源内容" v-model="addProForm.comContent" ref="addProForm.comContent"></el-input>
        </el-form-item>
    </el-form>
    <el-row>
        <el-col :span="11" style="text-align:right">
            <el-button type="primary" size="small" @click.native="conformEvent('addProForm')">保存</el-button>
        </el-col>
        <el-col :span="11" style="text-align: left" :offset="2">
            <el-button type="primary" size="small" @click.native="cancel">取消</el-button>
        </el-col>
    </el-row>
</div>
<template id="conTableField">
    <el-select v-model="conTableFieldInput"  clearable filterable placeholder="请选择关联表字段">
        <el-option v-for="item in options"
                   :key="item.rowId"
                   :label="item.columnCname"
                   :value="item.rowId">
        </el-option>
    </el-select>
</template>

<script>
    Vue.component('select-contablefield',SelectOptions.ConSetOpt('conTableField','conTableFieldInput',basLeft.relateTableRowId,conChildTable));
    Vue.component('select-vtype', SelectOptions.setOpt('','value','valueType',''));
    Vue.component('select-vorigin', SelectOptions.setOpt('','value','valueTypeOrigin',''));

    var proEm = new Vue({
        el: '#addProEvent',
        data: function () {
                return {
                    labelPosition: 'right',
                    addProForm: {
                        codeProInput: '',
                        nameProInput: '',
                        checked: false,
//                        tableReaInput: '',
//                        typeComValue: '',
                        comContent: '',
//                        typeInput: '',
                        disabled: true,
                        iconEvent: false,
                        checkEvent: false,
                        reaTabEvent:false,
                        dataId:'',
                        flag:true,
                    },
                    optionValue:[],
                    optionLeft: [],
                    optionRight: [],
                    rules: {
                        nameProInput: [
                            {required: true, message: '请输入属性名称', trigger: 'change'}
                        ],
//                        checked: [
//                            {required: true, message: '请选择扩展属性', trigger: 'click' }
//                        ],
//                        tableReaInput: [
//                            { required: true, message: '请选择关联表字段', trigger: 'blur'}
//                        ],
//                        typeInput: [
//                            {required: true, message: '请选择值类型', trigger: 'change'}
//                        ],
//                        typeComValue: [
//                            {required: true, message: '请选择值类型来源', trigger: 'change'}
//                        ],
//                        comContent: [
//                            {required: true, message: '请输入值来源内容', trigger: 'blur'}
//                        ]
                    }
                }
        },
        methods: {
            searchProTable(){
                this.checked = false  //点击选择表 按钮不选中
                var htmlUrl = 'connect-child.html';
                littledivIndex = ibcpLayer.ShowIframe(htmlUrl, '关联表字段', '600px', '560px', false)
            },
            changEvent(){
//                console.log(111)
//                if (proEm.addProForm.checked ==true) {
//                    proEm.$refs.contablefield.conTableFieldInput='';
//                }
            },
            changeReaTable(e){
                console.log(111)
                console.log(e)
//                proEm.dataId=e;
//                console.log( proEm.dataId)
//                if(operateOPr==1){  //新增的时候
//                    if(proEm.dataId!=''){
//                        proEm.addProForm.checked = false;   //关联表与是否属性只能选其一
//                    }
//                }
//                if(operateOPr==2){  //编辑的时候
//                    if(proEm.dataId!=undefined){
//                        proEm.addProForm.checked = false;   //关联表与是否属性只能选其一
//                    }
//                }
            },
            conformEvent(addProForm) {
                console.log(proEm.$refs.contablefield.conTableFieldInput)
                if(proEm.addProForm.checked==true&proEm.$refs.contablefield.conTableFieldInput!='') {
                    ibcpLayer.ShowMsg('扩展属性与关联表字段只能选其一')
                    return;
                }
//                proEm.flag=false;
//                if (this.checked == true) {
//                    var datas = [this.$refs.nameProInput, this.$refs.typeInput, this.$refs.typeComValue, this.$refs.comContent];
//                } else {
//                    var datas = [this.$refs.nameProInput, this.$refs.tableReaInput, this.$refs.typeInput, this.$refs.typeComValue, this.$refs.comContent];
//                }
//                for (var i = 0; i < datas.length; i++) {
//                    if (datas[i].value == '') {
//                        ibcpLayer.ShowMsg(datas[i].placeholder);
//                        return;
//                    }
//                }
                proEm.$refs[addProForm].validate(function (valid) {
                    if (valid) {
                        if(operateOPr==1){
                            addObj.addOk(function(){
                                proEm.$http.jsonp(serverPath + "/businObjPro/add", {
                                    objRowId: basLeft.currentId,//左边表的ID
                                    propertyName: proEm.addProForm.nameProInput,//业务对象属性名称
                                    wetherExpandPro: proEm.addProForm.checked,//是否为扩展属性
                                    relateTableColumn: proEm.$refs.contablefield.conTableFieldInput,//关联表字段
                                    valueType: proEm.$refs.vtype.value,//值类型
                                    valueResourceType: proEm.$refs.vorigin.value,//值来源类型
                                    valueResourceContent: proEm.addProForm.comContent,//值来源内容
                                }, {
                                    jsonp: 'callback'
                                }).then(function (res) {
                                    showMsg.MsgOk(basTop,res);
                                    basRight.rightInput='';
                                    //分页跳回到第一页
                                    queryData.getDatas(qurProUrl,basRight.rightInput,basLeft.currentId,basRight,function(res){

                                    });
                                    ibcpLayer.Close(divIndex);
                                });
                            },function(){
                                showMsg.MsgError(basTop)
                            })
                        }
                        else if(operateOPr==2){
                            console.log(basRight.currentVal.rowId)
                            editObj.editOk(function(){
                                proEm.$http.jsonp(serverPath + "/businObjPro/modify", {
                                    rowId: basRight.currentVal.rowId,//本生的ID
                                    objRowId: basLeft.currentId,//左边表的ID
                                    propertyCode: proEm.addProForm.codeProInput,//业务对象代码
                                    propertyName: proEm.addProForm.nameProInput,//业务对象属性名称
                                    wetherExpandPro: proEm.addProForm.checked,//是否为扩展属性
                                    relateTableColumn:  proEm.$refs.contablefield.conTableFieldInput,//关联表字段
                                    valueType: proEm.$refs.vtype.value,//值类型
                                    valueResourceType: proEm.$refs.vorigin.value,//值来源类型
                                    valueResourceContent: proEm.addProForm.comContent,//值来源内容
                                }, {
                                    jsonp: 'callback'
                                }).then(function (res) {
                                    showMsg.MsgOk(basTop,res);
                                    basRight.rightInput='';
                                    queryData.getDatas(qurProUrl,basRight.rightInput,basLeft.currentId,basRight,function(res){});
                                    ibcpLayer.Close(divIndex);
                                });
                            },function(){
                                showMsg.MsgError(basTop)
                            });
                        }
                    }else {
                        return false;
                    }
                })

            },
            cancel() {
                ibcpLayer.Close(divIndex);
            }
        },
        updated() {
//            if(proEm.$refs.contablefield.conTableFieldInput!=''){
//                proEm.addProForm.checked =true
//            }
            //console.log(proEm.$refs.contablefield.conTableFieldInput)
        }
    })



</script>
</body>
</html>